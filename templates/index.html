{% extends "base_html_template.html" %}


{% set short_title = "" %}
{% set long_title = databases[current_database] %}
{% set waterSensorURL = "/sensors/" + current_database +"/Water" %}
{% set airSensorURL = "/sensors/" + current_database + "/Atmospheric" %}

{% block page %}
<div class="row">

    <div id="plantTray">
        
    </div>
    <div class="col-xs-8 col-md-5 plantInfoBox">
       <div role="tabpanel" class="well">

          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist" id="infoBoxTabs">
            <li role="presentation" class="active"><a href="#plants" aria-controls="plants" role="tab" data-toggle="tab">Plants</a></li>
            <li role="presentation"><a href="#controls" aria-controls="controls" role="tab" data-toggle="tab">Controls</a></li>
            <li role="presentation"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">Messages</a></li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade in active" id="plants">
                <h4>Click a plant!</h4>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="controls">
                <h4>LEDs</h4>
                <b>Color</b>
                <select id="ledColorSelector" onChange="changeLEDColor();">
                    <option>Red</option>
                    <option>Green</option>
                    <option>Blue</option>
                    <option>Purple</option>
                    <option>Yellow</option>
                    <option>White</option>
                </select>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="messages"><h4>Coming soon!</h4></div>
          </div>
          

        </div>
    </div>
</div>
        
<!--
        <div class="row">
            <div class="col-md-6">
                <div class="callout callout-green">
                        <h3><a href="#">{{ long_title }} Plant 1</a></h3>
                        <div class="alert alert-info" role="alert">Growth to be completed in 4 days</div>
                        <div class="alert alert-danger" role="alert">pH has dropped to 6.2!</div>

                </div>
            </div>
            <div class="col-md-6">
                <div class="callout callout-yellow">
                    <h1>Updates</h1>
                    
                    <div class="alert alert-info" role="alert">Growth to be completed in 4 days</div>
                    <div class="alert alert-danger" role="alert">pH has dropped to 6.2!</div>
                    
                </div>
            </div>
        </div>
-->

    
<script>
    //Draw System
    var system = "{{ current_database }}"
    var trayType = {{ tray|safe }}
    
    var lightColor = "Red";  //to come from system data
    var svgWidth, svgHeight; 
    var boxdim, plantSize;
    var padding, lightPadding, xplantPadding, yplantPadding;
    var plantLocations, plantIDs, plantsInBot;
    var outterBox, innerBox;
    var plantTray = d3.select("body").select("#plantTray")
                      .append("svg")
                      .attr("id", "#plantTraySvg");

    if (trayType == 0){
        d3.select("#plantTray").attr("class", "col-xs-6");
        drawGroBot();
    }
    else if (trayType == 1){
        d3.select("#plantTray").attr("class", "col-xs-12 col-md-7");
        drawFullNormalTray();
    }
    else if (trayType == 2){
        d3.select("#plantTray").attr("class", "col-xs-12 col-md-7");
        drawFullWeirdTray();
    }
    else if (trayType == 3){
        d3.select("#plantTray").attr("class", "col-xs-3");
        drawSelectTray(system, trayList);
    }

    function drawGroBot(){
        svgWidth = 430;
        svgHeight = 430;
        boxdim = 430;
        padding = 5;
        lightPadding = 15;
        plantSize = 30;
        xplantPadding = (boxdim-2*lightPadding)/4 - plantSize/2;
        yplantPadding = (boxdim-2*lightPadding)/5 - plantSize/2;
        plantLocations = [[0,0],[0,0],
                              [1,1],[3,1],[5,1],
                                 [2,2],[4,2],
                              [1,3],[3,3],[5,3],
                                 [2,4],[4,4]];
        plantIDs = [0,0,10,7,6,13,9,1,2,3,4,5]
        
        plantTray.attr({
                "preserveAspectRatio": "xMinYMin meet",
                "viewBox": "0 0 430 430"
            });

        outterBox = plantTray.append("rect")
                              .attr({
                                "x": 0,
                                "y": 0,
                                "width": boxdim,
                                "height": boxdim,
                                "fill": lightColor,
                                "opacity": .4
                              });

        innerBox = plantTray.append("rect")
                             .attr({
                                "x": lightPadding,
                                "y": lightPadding,
                                "width": boxdim-2*lightPadding,
                                "height": boxdim-2*lightPadding,
                                "fill": "white"
                             });
        
        var xScalePlant = d3.scale.linear()
                    .domain([0,5])
                    .range([0, boxdim-lightPadding-xplantPadding]);
        var yScalePlant = d3.scale.linear()
                    .domain([1,4])
                    .range([yplantPadding, boxdim-lightPadding-yplantPadding]);

        plantsInBot = plantTray.selectAll("rect").data(plantLocations)
                        .enter().append("rect")
                        .attr({
                            "x": function(d){return xScalePlant(d[0])},
                            "y": function(d){return yScalePlant(d[1])},
                            "rx": 3,
                            "ry": 3,
                            "width": plantSize,
                            "height": plantSize, 
                            "fill": "green",
                            "id": function(d,i){
                                return plantIDs[i];
                            },
                            "onclick":function(d, i){
                                return "plantClick(" + plantIDs[i] + ")";
                            }
                        });

    }

    function drawFullNormalTray(){
        svgWidth = 930;
        svgHeight = 530;
        padding = 3;
        lightPadding = 15;
        plantSize = 26;
        xplantPadding = (svgWidth-2*lightPadding)/13 - plantSize/2;
        yplantPadding = (svgHeight-2*lightPadding)/5 - plantSize/2;
        plantLocations = [[0,0],[0,0],
                              [1,1],[3,1],[5,1],[7,1],[9,1],[11,1],[13,1],
                                 [2,2],[4,2],[6,2],[8,2],[10,2],[12,2],
                              [1,3],[3,3],[5,3],[7,3],[9,3],[11,3],[13,3],
                                 [2,4],[4,4],[6,4],[8,4],[10,4],[12,4],
                              [1,5],[3,5],[5,5],[7,5],[9,5],[11,5],[13,5]];
        plantIDs = [0,0,
                    0 ,1 ,2 ,3 ,4 ,5 ,6 ,
                     7 ,8 ,9 ,10,11,12,
                    13,14,15,16,17,18,19,
                     20,21,22,23,24,25,
                    26,27,28,29,30,31,32];
        
        plantTray.attr({
                "preserveAspectRatio": "xMinYMin meet",
                "viewBox": "0 0 " + svgWidth + " " + svgHeight
            });

        outterBox = plantTray.append("rect")
                              .attr({
                                "x": 0,
                                "y": 0,
                                "width": svgWidth,
                                "height": svgHeight,
                                "fill": lightColor,
                                "opacity": .4
                              });

        innerBox = plantTray.append("rect")
                             .attr({
                                "x": lightPadding,
                                "y": lightPadding,
                                "width": svgWidth-2*lightPadding,
                                "height": svgHeight-2*lightPadding,
                                "fill": "white"
                             });
        
        var xScalePlant = d3.scale.linear()
                    .domain([1,13])
                    .range([xplantPadding, svgWidth-lightPadding-plantSize- xplantPadding]);
        var yScalePlant = d3.scale.linear()
                    .domain([1,5])
                    .range([xplantPadding, svgHeight-lightPadding-xplantPadding]);

        plantsInBot = plantTray.selectAll("rect").data(plantLocations)
                        .enter().append("rect")
                        .attr({
                            "x": function(d){return xScalePlant(d[0])},
                            "y": function(d){return yScalePlant(d[1])},
                            "rx": 3,
                            "ry": 3,
                            "width": plantSize,
                            "height": plantSize, 
                            "fill": "green",
                            "id": function(d,i){
                                return plantIDs[i];
                            },
                            "onclick":function(d, i){
                                return "plantClick(" + plantIDs[i] + ")";
                            }
                        });
    }

    function drawFullWeirdTray(){
        svgWidth = 930;
        svgHeight = 530;
        padding = 3;
        lightPadding = 15;
        plantSize = 26;
        xplantPadding = (svgWidth-2*lightPadding)/13 - plantSize/2;
        yplantPadding = (svgHeight-2*lightPadding)/6 - plantSize/2;
        plantLocations = [[0,0],[0,0],
                              [1,1],[3,1],[5,1],[7,1],[9,1],[11,1],[13,1],
                                 [2,2],[4,2],[6,2],[8,2],[10,2],[12,2],
                              [1,3],[3,3],[5,3],[7,3],[9,3],[11,3],[13,3],
                                 [2,4],[4,4],[6,4],[8,4],[10,4],[12,4],
                              [1,5],[3,5],[5,5],[7,5],[9,5],[11,5],[13,5],
                                 [2,6],[4,6],[6,6],[8,6],[10,6],[12,6]];
        plantIDs = [0,0,
                    0 ,1 ,2 ,3 ,4 ,5 ,6 ,
                     7 ,8 ,9 ,10,11,12,
                    13,14,15,16,17,18,19,
                     20,21,22,23,24,25,
                    26,27,28,29,30,31,32];
        
        plantTray.attr({
                "preserveAspectRatio": "xMinYMin meet",
                "viewBox": "0 0 " + svgWidth + " " + svgHeight
            });

        outterBox = plantTray.append("rect")
                              .attr({
                                "x": 0,
                                "y": 0,
                                "width": svgWidth,
                                "height": svgHeight,
                                "fill": lightColor,
                                "opacity": .4
                              });

        innerBox = plantTray.append("rect")
                             .attr({
                                "x": lightPadding,
                                "y": lightPadding,
                                "width": svgWidth-2*lightPadding,
                                "height": svgHeight-2*lightPadding,
                                "fill": "white"
                             });
        
        var xScalePlant = d3.scale.linear()
                    .domain([1,13])
                    .range([xplantPadding, svgWidth-lightPadding-plantSize- xplantPadding]);
        var yScalePlant = d3.scale.linear()
                    .domain([1,6])
                    .range([xplantPadding, svgHeight-lightPadding-xplantPadding]);

        plantsInBot = plantTray.selectAll("rect").data(plantLocations)
                        .enter().append("rect")
                        .attr({
                            "x": function(d){return xScalePlant(d[0])},
                            "y": function(d){return yScalePlant(d[1])},
                            "rx": 3,
                            "ry": 3,
                            "width": plantSize,
                            "height": plantSize, 
                            "fill": "green",
                            "id": function(d,i){
                                return plantIDs[i];
                            },
                            "onclick":function(d, i){
                                return "plantClick(" + plantIDs[i] + ")";
                            }
                        });
    }
    function drawSelectTray(system, trayList){
        var change = "goToTray(\"" + system + "\")";
        var selectBox = d3.select("body").select("#plantTray").append("select")
                          .attr("id","selectBox")
                          .attr("onChange", change);

        var options = selectBox.selectAll("option")
                            .data(trayList).enter()
                            .append("option")
                            .text(function(d, i) { return i+1; });   
    }
    function goToTray(system){
        tray = $("#selectBox").children("option:selected").text();
        
        window.location.replace ("/" + system + "/" + tray);
    }
    //Other Functions
    $('#infoBoxTabs a:first').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    });

    function changeLEDColor(){
        
        lightColor = $('#ledColorSelector').children("option:selected").text();
        //console.log ("lightColor is " + lightColor);
        outterBox.attr({"fill":lightColor});
    }

    function plantClick(plantID){
        $('#infoBoxTabs a:first').tab('show')
        var newTabContent = plantID;
        $('#plants').text(newTabContent);
    }
    
</script>

{% endblock %}
