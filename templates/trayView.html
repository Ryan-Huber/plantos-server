{% extends "base_html_template.html" %}


{% set short_title = "" %}
{% set long_title = databases[current_database] %}
{% set waterSensorURL = "/sensors/" + current_database +"/Water" %}
{% set airSensorURL = "/sensors/" + current_database + "/Atmospheric" %}

{% block page %}
<div class="platos-page container-fluid">
    <div >
        <h2>{{ long_title }}<h2>
    </div>

    <div class="row">

        <div id="plantTray">
            
        </div>
        <div class="col-xs-8 col-md-5 plantInfoBox">
           <div role="tabpanel" class="well">

              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist" id="infoBoxTabs">
                <li role="presentation" class="active"><a href="#plants" aria-controls="plants" role="tab" data-toggle="tab">Plants</a></li>
                <li role="presentation"><a href="#controls" aria-controls="controls" role="tab" data-toggle="tab">Controls</a></li>
                <li role="presentation"><a href="#sensorTab" aria-controls="messages" role="tab" data-toggle="tab">Sensors</a></li>
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">
                <div role="tabpanel" class="tab-pane fade in active" id="plants">
                    <h4>Click a plant!</h4>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="controls">
                    <h4>Coming soon!</h4>
                <!--
                    <h4>LEDs</h4>
                    <b>Color</b>
                    <select id="ledColorSelector" onChange="changeLEDColor();">
                        <option>Red</option>
                        <option>Green</option>
                        <option>Blue</option>
                        <option>Purple</option>
                        <option>Yellow</option>
                        <option>White</option>
                    </select>
                -->
                </div>
                <div role="tabpanel" class="tab-pane fade" id="sensorTab"><h4>Coming soon!</h4></div>
              </div>
              

            </div>
        </div>
    </div>
</div>
    
<script>
    //Draw System
    var system = "{{ current_database }}"
    var trayType = {{ tray|safe }};
    var plantLocations = {{ plantLocations|safe }};
    var plantInfo = {{ plants|safe }}
    var lightColor = "Red";  //to come from system data
    var svgWidth, svgHeight; 
    var boxdim, plantSize, imgSize;
    var padding, lightPadding, xplantPadding, yplantPadding, xScalar, yScalar;
    var plantIDs, plantsInBot;
    var outterBox, innerBox;
    var plantTray = d3.select("body").select("#plantTray")
                      .append("svg")
                      .attr("id", "#plantTraySvg");
    if (trayType == 0){
        d3.select("#plantTray").attr("class", "col-xs-12 col-md-5");
        drawGroBot();
    }
    else if (trayType == 1){
        d3.select("#plantTray").attr("class", "col-xs-12 col-md-7");
        drawFullNormalTray();
    }
    else if (trayType == 2){
        d3.select("#plantTray").attr("class", "col-xs-12 col-md-7");
        drawFullWeirdTray();
    }
    else if (trayType == 3){
        d3.select("#plantTray").attr("class", "col-xs-3");
        drawSelectTray(system, trayList);
    }
    function drawGroBot(){
        svgWidth = 430;
        svgHeight = 430;
        boxdim = 430;
        padding = 5;
        lightPadding = 15;
        plantSize = 30;
        imgSize = 50;
        xplantPadding = (boxdim-2*lightPadding)/5 - plantSize/2;
        yplantPadding = (boxdim-2*lightPadding)/4 - plantSize/2;
        xScalar = 4;
        yScalar = 5;
        drawTray(); 
    }
    function drawFullNormalTray(){
        svgWidth = 930;
        svgHeight = 530;
        padding = 3;
        lightPadding = 15;
        plantSize = 34;
        imgSize = 60;
        xplantPadding = (svgWidth-2*lightPadding)/11 - plantSize/2;
        yplantPadding = (svgHeight-2*lightPadding)/5 - plantSize/2;
        xScalar = 11;
        yScalar = 5;
        drawTray();
    }
    function drawFullWeirdTray(){
        svgWidth = 930;
        svgHeight = 530;
        padding = 3;
        lightPadding = 15;
        plantSize = 34;
        imgSize = 54;
        xplantPadding = (svgWidth-2*lightPadding)/12 - plantSize/2;
        yplantPadding = (svgHeight-2*lightPadding)/6 - plantSize/2;
        xScalar = 12;
        yScalar = 6;
        drawTray();
    }
    function drawTray(){
        plantTray.attr({
                "preserveAspectRatio": "xMinYMin meet",
                "viewBox": "0 0 " + svgWidth + " " + svgHeight
            });
        outterBox = plantTray.append("rect")
                          .attr({
                            "x": 0,
                            "y": 0,
                            "width": svgWidth,
                            "height": svgHeight,
                            "fill": lightColor,
                            "opacity": .4
                          });
        innerBox = plantTray.append("rect")
                         .attr({
                            "x": lightPadding,
                            "y": lightPadding,
                            "width": svgWidth-2*lightPadding,
                            "height": svgHeight-2*lightPadding,
                            "fill": "white"
                         });
        
        var xScalePlant = d3.scale.linear()
                    .domain([1,xScalar])
                    .range([xplantPadding, svgWidth-lightPadding-plantSize- xplantPadding]);
        var yScalePlant = d3.scale.linear()
                    .domain([yScalar,1])
                    .range([xplantPadding, svgHeight-lightPadding-xplantPadding]);
        for(i=0;i<plantLocations.length;i++){
            if (plantInfo[i]["image"] == ""){
                noImagePlant(plantLocations[i], i)
            }
            else{
                plantWithPic(plantLocations[i], i)
            }
        }
        function noImagePlant(loc, i){
            var op = .9;
            var onclick = "plantClick(" + i + ")";
            var className = "hoverBox";
            if (plantInfo[i]["plantName"]=="Not Planted"){
                op = .3;
                onclick = "";
                className = "noHover";
            }

            plantTray.append("rect")
                    .attr({
                        "x": xScalePlant(loc[0]),
                        "y": yScalePlant(loc[1]),
                        "rx": 10,
                        "ry": 10,
                        "width": plantSize,
                        "height": plantSize, 
                        "fill": "green",
                        "opacity":op,
                        "id": "plant" + i,
                        "onclick":onclick,
                        "class":className,
                        "stroke":"green",
                        "stroke-width":0
                    });
        }
        
        function plantWithPic(loc, i){
            var xyFix = (imgSize-plantSize)/2;
            var className = "hoverImg";
            plantTray.append("image")
                .attr({
                    "x": xScalePlant(loc[0])-xyFix,
                    "y": yScalePlant(loc[1])-xyFix,
                    "width": imgSize,
                    "height": imgSize,
                    "xlink:href":"/static/img/plantimg/" + plantInfo[i]["image"],
                    "onclick":"plantClick(" + i + ")",
                    "class":className,
                    "box-shadow":"none"
                });
        }
    }
    //Other Functions
    $('#infoBoxTabs a:first').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    });
    function changeLEDColor(){
        lightColor = $('#ledColorSelector').children("option:selected").text();
        outterBox.attr({"fill":lightColor});
    }
    function plantClick(plantID){
        $('#infoBoxTabs a:first').tab('show')
        var plantName = plantInfo[plantID]["plantName"];
        var dateSown = plantInfo[plantID]["dateSown"];
        box = d3.select("#plants")
        box.selectAll("*").remove();
        box.append("h4").text("Name: " + plantName);
        box.append("h4").text("Date Sown: " + dateSown)
    }
    
    
</script>

{% endblock %}